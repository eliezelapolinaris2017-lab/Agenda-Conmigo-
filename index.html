<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
<title>Salon Pro ‚Äî Dashboard</title>
<style>
/* ====== CSS Base / Theming ====== */
:root{
  --bg:#0f0f12;
  --fg:#ffffff;
  --muted:#a7a7b1;
  --primary:#6ee7b7;
  --topbar:#15151b;
  --card:#1a1b23;
  --btn:#26283a;
  --accent:#93c5fd;
  --danger:#ef4444;
  --ok:#22c55e;
  --warn:#f59e0b;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg) no-repeat center/cover;
  color:var(--fg);font-family:var(--font);
}
.topbar{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;gap:.6rem;
  padding:.6rem .9rem;background:var(--topbar);border-bottom:1px solid #00000055;
}
.logo{
  width:34px;height:34px;border-radius:6px;object-fit:contain;background:#0003;display:inline-block
}
.title{font-weight:700;letter-spacing:.2px}
.spacer{flex:1}
.btn{
  display:inline-flex;align-items:center;gap:.5rem;
  padding:.55rem .8rem;border-radius:10px;border:1px solid #00000066;
  background:var(--btn);color:var(--fg);cursor:pointer;font-weight:600;
}
.btn.small{padding:.35rem .6rem;font-size:.9rem;border-radius:8px}
.btn.ghost{background:transparent}
.btn.primary{background:var(--accent)}
.btn.ok{background:var(--ok)}
.btn.warn{background:var(--warn)}
.btn.danger{background:var(--danger)}
.hidden{display:none !important}
.container{max-width:1000px;margin:1rem auto;padding:0 1rem}
.card{
  background:var(--card);border:1px solid #00000055;border-radius:14px;padding:1rem;margin:.7rem 0;
}
.grid{display:grid;gap:1rem}
.grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid.three{grid-template-columns:repeat(3,minmax(0,1fr))}
label{display:block;margin:.4rem 0 .2rem;color:var(--muted);font-size:.9rem}
input,select,textarea{
  width:100%;padding:.55rem .6rem;border-radius:10px;border:1px solid #00000055;background:#0f1017;color:var(--fg)
}
input[type="color"]{padding:.2rem;height:38px}
.row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
.kbd{background:#0002;border:1px solid #0003;border-radius:6px;padding:.1rem .35rem;font-size:.85rem}
.menu{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:.7rem
}
.menu .item{
  user-select:none;cursor:grab;list-style:none;text-align:left;padding:1rem;border-radius:12px;background:#171827;border:1px dashed #2b2c3f
}
.menu .item .ico{font-size:1.25rem;margin-bottom:.5rem}
.badge{font-size:.75rem;padding:.15rem .45rem;border-radius:999px;background:#ffffff22}
table{width:100%;border-collapse:collapse}
th,td{padding:.55rem;border-bottom:1px solid #00000055}
th{color:var(--muted);text-align:left}
hr{border:none;border-top:1px solid #00000055;margin:1rem 0}
footer{opacity:.8;text-align:center;padding:2rem 0}

/* Print styles (PDF) */
@media print{
  body{background:#fff;color:#000}
  .topbar,.btn,.no-print{display:none !important}
  .card{border:1px solid #ddd}
}

/* Login */
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:70vh}
.brand-preview{display:flex;align-items:center;gap:.7rem}

/* Calendar mini */
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:.25rem}
.calendar .day{padding:.5rem;border-radius:8px;background:#0f1017;border:1px solid #00000055;text-align:center}
.calendar .today{outline:2px solid var(--accent)}
.tag{padding:.12rem .4rem;border-radius:8px;background:#ffffff18;font-size:.8rem}
.scroll{max-height:260px;overflow:auto;border:1px solid #00000033;border-radius:10px}
</style>
</head>
<body>
  <!-- ===== Topbar ===== -->
  <div class="topbar no-print">
    <img id="logoTop" class="logo" alt="logo">
    <div class="title" id="salonName">Mi Sal√≥n</div>
    <span class="spacer"></span>
    <button class="btn small" id="btnDashboard">üè† Men√∫</button>
    <button class="btn small" id="btnLogout" title="Cerrar sesi√≥n">üîì Salir</button>
  </div>

  <div class="container">
    <!-- ===== Login ===== -->
    <section id="viewLogin" class="login-wrap">
      <div class="card" style="min-width:320px;max-width:420px">
        <div class="brand-preview">
          <img id="logoLogin" class="logo" alt="logo">
          <div>
            <div style="font-weight:800" id="salonNameLogin">Mi Sal√≥n</div>
            <small style="opacity:.7">Acceso</small>
          </div>
        </div>
        <hr>
        <label>Usuario</label>
        <input id="loginUser" placeholder="usuario">
        <label>Contrase√±a</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div class="row" style="margin-top:.7rem">
          <button class="btn ok" id="btnDoLogin">Ingresar</button>
          <span class="kbd">Admin demo: admin / admin</span>
          <span class="kbd">Usuario demo: user / user</span>
        </div>
      </div>
    </section>

    <!-- ===== Men√∫ principal ===== -->
    <section id="viewMenu" class="hidden">
      <div class="row">
        <div class="card" style="flex:1">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h2 style="margin:.2rem 0">Men√∫</h2>
            <span class="badge">Arrastra para reordenar</span>
          </div>
          <div id="menuList" class="menu no-print"></div>
        </div>
      </div>
    </section>

    <!-- ===== Agenda ===== -->
    <section id="viewAgenda" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="grid two">
        <div class="card">
          <h3>Crear / Editar cita</h3>
          <div class="grid two">
            <div>
              <label>Fecha</label><input type="date" id="apDate">
            </div>
            <div>
              <label>Hora</label><input type="time" id="apTime">
            </div>
            <div>
              <label>Cliente</label><input id="apClient" placeholder="Nombre y Apellido">
            </div>
            <div>
              <label>Tel√©fono</label><input id="apPhone" placeholder="+1...">
            </div>
            <div>
              <label>Servicio</label>
              <input id="apService" list="servicesList" placeholder="Corte, Color...">
              <datalist id="servicesList"></datalist>
            </div>
            <div>
              <label>T√©cnica</label>
              <select id="apTech"></select>
            </div>
          </div>
          <div class="row" style="margin-top:.6rem">
            <button class="btn ok" id="btnSaveAp">üíæ Guardar</button>
            <button class="btn warn" id="btnResched" title="Reagendar seleccionada">üîÑ Reagendar</button>
            <button class="btn danger" id="btnNoShow">üö´ No-show</button>
            <button class="btn" id="btnGCal">üìÖ Google Calendar</button>
            <button class="btn" id="btnWhats">üü¢ WhatsApp</button>
          </div>
          <small class="muted">Bloquea duplicados: misma persona + hora + d√≠a + t√©cnica.</small>
        </div>
        <div class="card">
          <h3>Calendario & Disponibilidad</h3>
          <div class="row">
            <input type="month" id="calMonth">
            <input type="date" id="filterDate">
            <input placeholder="Buscar por cliente" id="filterClient">
          </div>
          <div id="calendar" class="calendar" style="margin-top:.6rem"></div>
          <h4>Slots disponibles</h4>
          <div id="slots" class="scroll"></div>
        </div>
      </div>

      <div class="card">
        <h3>Citas (hoy y futuras)</h3>
        <div class="row">
          <button class="btn small" id="btnExportApPDF">üñ®Ô∏è PDF</button>
          <button class="btn small" id="btnExportApJSON">üíæ Exportar JSON</button>
          <input type="file" id="importApJSON" class="no-print" accept="application/json">
        </div>
        <table id="tblAp"></table>
      </div>
    </section>

    <!-- ===== Cobros / Facturas ===== -->
    <section id="viewBilling" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="grid two">
        <div class="card">
          <h3>Nuevo cobro / factura</h3>
          <div class="grid two">
            <div><label>Fecha</label><input type="date" id="invDate"></div>
            <div><label>Hora</label><input type="time" id="invTime"></div>
            <div><label>Cliente</label><input id="invClient"></div>
            <div><label>Tel√©fono</label><input id="invPhone"></div>
            <div>
              <label>Servicio</label>
              <input id="invService" list="servicesList">
            </div>
            <div>
              <label>T√©cnica</label>
              <select id="invTech"></select>
            </div>
            <div>
              <label>M√©todo de pago</label>
              <select id="invPay">
                <option>ATH M√≥vil</option>
                <option>Cash</option>
                <option>Tarjeta</option>
              </select>
            </div>
            <div>
              <label>Monto</label><input id="invAmount" type="number" step="0.01">
            </div>
          </div>
          <div class="row" style="margin-top:.6rem">
            <button class="btn ok" id="btnSaveInv">üíæ Guardar & Enviar a Hoja</button>
            <button class="btn" id="btnInvoicePDF">üñ®Ô∏è PDF</button>
          </div>
        </div>

        <div class="card">
          <h3>Hoja de Cuadre (Google Sheets)</h3>
          <p>URL configurada:</p>
          <code id="sheetUrlCode" style="word-break:break-all"></code>
          <div class="row" style="margin-top:.5rem">
            <button class="btn small" id="btnOpenSheet">Abrir Hoja</button>
            <button class="btn small" id="btnTestWebhook">Probar Webhook</button>
          </div>
          <small>Se hace <i>append</i> v√≠a webhook Apps Script al guardar factura.</small>
        </div>
      </div>

      <div class="card">
        <h3>Historial de cobros</h3>
        <div class="row">
          <button class="btn small" id="btnExportInvPDF">üñ®Ô∏è PDF</button>
          <button class="btn small" id="btnExportInvJSON">üíæ JSON</button>
          <button class="btn small" id="btnExportInvCSV">üìÑ CSV</button>
          <input type="file" id="importInvJSON" class="no-print" accept="application/json">
        </div>
        <table id="tblInv"></table>
      </div>
    </section>

    <!-- ===== Rendimiento (Analytics) ===== -->
    <section id="viewAnalytics" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="grid two">
        <div class="card">
          <h3>Indicadores</h3>
          <div class="row">
            <select id="rangeKPI">
              <option value="day">Diario</option>
              <option value="week">Semanal</option>
              <option value="month" selected>Mensual</option>
            </select>
            <button class="btn small" id="btnExportAnalPDF">üñ®Ô∏è PDF</button>
          </div>
          <div id="kpis" class="grid three"></div>
        </div>
        <div class="card">
          <h3>Gr√°ficas</h3>
          <canvas id="chart1" height="160"></canvas>
          <canvas id="chart2" height="160" style="margin-top:1rem"></canvas>
        </div>
      </div>
      <div class="card">
        <h3>Historial</h3>
        <div class="row">
          <button class="btn small" id="btnExportLogsPDF">üñ®Ô∏è PDF</button>
        </div>
        <table id="tblLogs"></table>
      </div>
    </section>

    <!-- ===== Configuraci√≥n ===== -->
    <section id="viewConfig" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="grid two">
        <div class="card">
          <h3>Branding & Estilo</h3>
          <div class="grid two">
            <div><label>Nombre del sal√≥n</label><input id="cfgSalonName" placeholder="Mi Sal√≥n"></div>
            <div><label>Fuente</label><input id="cfgFont" placeholder="Inter, system-ui"></div>
            <div><label>Color fondo</label><input type="color" id="cfgBg"></div>
            <div><label>Color topbar</label><input type="color" id="cfgTopbar"></div>
            <div><label>Color botones</label><input type="color" id="cfgBtn"></div>
            <div><label>Color acento</label><input type="color" id="cfgAccent"></div>
          </div>
          <label>Imagen de fondo (PNG transparente opcional)</label>
          <input type="file" id="cfgBgImg" accept="image/*">
          <label>Logo</label>
          <input type="file" id="cfgLogo" accept="image/*">
          <label>Footer</label><input id="cfgFooter" placeholder="¬© Mi Sal√≥n">
          <div class="row" style="margin-top:.6rem">
            <button class="btn ok" id="btnSaveTheme">Guardar estilo</button>
            <button class="btn" id="btnExportCfg">Exportar Config JSON</button>
            <input type="file" id="importCfg" accept="application/json">
          </div>
        </div>

        <div class="card">
          <h3>T√©cnicas / Estilistas</h3>
          <div class="row">
            <input id="techNew" placeholder="Agregar t√©cnica...">
            <button class="btn small" id="btnAddTech">Agregar</button>
          </div>
          <ul id="techList"></ul>
          <hr>
          <h3>Servicios & Precios (CRUD)</h3>
          <div class="row">
            <input id="srvName" placeholder="Servicio">
            <input id="srvPrice" type="number" step="0.01" placeholder="Precio">
            <button class="btn small" id="btnAddSrv">Agregar</button>
          </div>
          <table id="tblSrv"></table>
          <hr>
          <h3>Orden del men√∫ (drag & drop)</h3>
          <div id="menuOrder" class="menu"></div>
        </div>
      </div>

      <div class="card">
        <h3>Usuarios & permisos</h3>
        <div class="grid two">
          <div>
            <h4>Crear usuario</h4>
            <input id="uUser" placeholder="usuario">
            <input id="uPass" type="password" placeholder="contrase√±a">
            <select id="uRole">
              <option>admin</option>
              <option>user</option>
            </select>
            <button class="btn small" id="btnAddUser">Agregar</button>
          </div>
          <div>
            <h4>Listado</h4>
            <table id="tblUsers"></table>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Backups ===== -->
    <section id="viewBackups" class="hidden">
      <div class="row"><button class="btn ghost" data-back>‚Üê Regresar al men√∫</button></div>
      <div class="card">
        <h3>Backups & restauraci√≥n</h3>
        <div class="grid two">
          <div>
            <h4>Citas</h4>
            <div class="row">
              <button class="btn small" data-backup="appointments:daily">Diario</button>
              <button class="btn small" data-backup="appointments:weekly">Semanal</button>
              <button class="btn small" data-backup="appointments:monthly">Mensual</button>
              <button class="btn small" data-backup="appointments:yearly">Anual</button>
            </div>
          </div>
          <div>
            <h4>Cobros & No-shows</h4>
            <div class="row">
              <button class="btn small" data-backup="billing:daily">Diario</button>
              <button class="btn small" data-backup="billing:weekly">Semanal</button>
              <button class="btn small" data-backup="billing:monthly">Mensual</button>
              <button class="btn small" data-backup="billing:yearly">Anual</button>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:.6rem">
          <button class="btn" id="btnSchedBackups">Programar frecuencias</button>
          <button class="btn" id="btnExportAll">Exportar TODO (ZIP-like JSON)</button>
          <input type="file" id="importAll" accept="application/json">
        </div>
      </div>
    </section>

    <!-- ===== Footer ===== -->
    <footer id="appFooter" class="no-print">¬© Mi Sal√≥n</footer>
  </div>

<script>
/* ====== Utilidades y estado ====== */
const S = {
  key:k=>`salon.${k}`,
  load:(k,def)=>{try{return JSON.parse(localStorage.getItem(S.key(k))) ?? def}catch{return def}},
  save:(k,v)=>localStorage.setItem(S.key(k),JSON.stringify(v)),
  uid:()=>Math.random().toString(36).slice(2),
  today:()=>new Date().toISOString().slice(0,10),
  nowTime:()=>new Date().toTimeString().slice(0,5),
  pad:n=>n.toString().padStart(2,'0'),
  toLocalDateTimeStr:(d)=>`${d.getFullYear()}-${S.pad(d.getMonth()+1)}-${S.pad(d.getDate())} ${S.pad(d.getHours())}:${S.pad(d.getMinutes())}`,
  csv:(rows)=>rows.map(r=>r.map(x=>`"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n'),
  download:(name,content,type='application/json')=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href);
  },
  notify:(msg)=>{console.log(msg); alert(msg)},
  isSameDay:(a,b)=>a.toISOString().slice(0,10)===b.toISOString().slice(0,10),
  addDays:(d, n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x}
};

// Estado inicial
const state = {
  session: S.load('session', null),
  cfg: S.load('cfg',{
    salonName:'Mi Sal√≥n',
    font:'Inter, system-ui',
    colors:{bg:'#0f0f12',topbar:'#15151b',btn:'#26283a',accent:'#93c5fd'},
    footer:'¬© Mi Sal√≥n',
    logo:null, bgImage:null,
    sheetUrl:'https://docs.google.com/spreadsheets/d/1-MxlLqk6BLkYiThYros0F3DLCef0jd5tV-pUilMk3iM/edit',
    webhookUrl:'' // Tu Apps Script web app (doPost)
  }),
  users: S.load('users',[
    {user:'admin',pass:'admin',role:'admin'},
    {user:'user',pass:'user',role:'user'}
  ]),
  menu: S.load('menu',[
    {id:'Agenda', ico:'üìÖ', view:'viewAgenda', role:'user'},
    {id:'Cobros/Facturas', ico:'üí≥', view:'viewBilling', role:'user'},
    {id:'Rendimiento', ico:'üìà', view:'viewAnalytics', role:'admin'},
    {id:'Configuraci√≥n', ico:'‚öôÔ∏è', view:'viewConfig', role:'admin'},
    {id:'Backups', ico:'üóÇÔ∏è', view:'viewBackups', role:'admin'}
  ]),
  techs: S.load('techs',['General']),
  services: S.load('services',[
    {name:'Corte', price:25},{name:'Color', price:60},{name:'Blowout', price:30}
  ]),
  appointments: S.load('appointments',[]),
  invoices: S.load('invoices',[]),
  noshows: S.load('noshows',[]),
  logs: S.load('logs',[])
};

function persistAll(){
  ['cfg','users','menu','techs','services','appointments','invoices','noshows','logs'].forEach(k=>S.save(k,state[k]));
}

/* ====== Theming / Branding ====== */
function applyTheme(){
  document.documentElement.style.setProperty('--bg', state.cfg.colors.bg);
  document.documentElement.style.setProperty('--topbar', state.cfg.colors.topbar);
  document.documentElement.style.setProperty('--btn', state.cfg.colors.btn);
  document.documentElement.style.setProperty('--accent', state.cfg.colors.accent);
  document.body.style.fontFamily = state.cfg.font;
  document.getElementById('appFooter').textContent = state.cfg.footer || '';
  document.getElementById('salonName').textContent = state.cfg.salonName;
  document.getElementById('salonNameLogin').textContent = state.cfg.salonName;
  if(state.cfg.bgImage) document.body.style.backgroundImage = `url(${state.cfg.bgImage})`; else document.body.style.backgroundImage='none';
  const logos = document.querySelectorAll('#logoTop,#logoLogin');
  logos.forEach(el=>{ if(state.cfg.logo){el.src=state.cfg.logo}else{el.removeAttribute('src')}});
  document.getElementById('sheetUrlCode').textContent = state.cfg.sheetUrl || '(no configurado)';
}

/* ====== Router simple ====== */
const views = ['viewLogin','viewMenu','viewAgenda','viewBilling','viewAnalytics','viewConfig','viewBackups'];
function show(view){
  views.forEach(v=>document.getElementById(v).classList.add('hidden'));
  document.getElementById(view).classList.remove('hidden');
}
function toMenu(){ buildMenu(); show('viewMenu'); }

/* ====== Login & permisos ====== */
function login(u,p){
  const found = state.users.find(x=>x.user===u && x.pass===p);
  if(!found) return S.notify('Usuario o contrase√±a incorrectos');
  state.session = {user:found.user, role:found.role, ts:Date.now()};
  S.save('session',state.session);
  log('login',`${found.user}`);
  applyRoleVisibility();
  toMenu();
}
function logout(){ state.session=null; S.save('session',null); show('viewLogin'); }
function applyRoleVisibility(){
  // esconder √≠tems no permitidos en men√∫ din√°micamente
}

/* ====== Men√∫ con drag & drop ====== */
function buildMenu(){
  const ml=document.getElementById('menuList'); ml.innerHTML='';
  const role=state.session?.role||'user';
  state.menu.filter(m=>role==='admin'||m.role!=='admin').forEach(m=>{
    const el=document.createElement('div');
    el.className='item'; el.draggable=true; el.dataset.view=m.view;
    el.innerHTML=`<div class="ico">${m.ico}</div><div style="font-weight:700">${m.id}</div><div class="tag">${m.view}</div>`;
    el.addEventListener('click',()=>{ show(m.view); if(m.view==='viewAgenda') renderAgenda(); if(m.view==='viewBilling') renderBilling(); if(m.view==='viewAnalytics') renderAnalytics(); if(m.view==='viewConfig') renderConfig(); if(m.view==='viewBackups') renderBackups(); });
    el.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',m.view));
    ml.appendChild(el);
  });
  // √Årea de orden en Config
  const mo=document.getElementById('menuOrder'); mo.innerHTML='';
  state.menu.forEach(m=>{
    const li=document.createElement('div'); li.className='item'; li.draggable=true; li.dataset.view=m.view; li.innerHTML=`<div class="ico">${m.ico}</div><div>${m.id}</div>`;
    li.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',m.view));
    li.addEventListener('dragover',e=>e.preventDefault());
    li.addEventListener('drop',e=>{
      e.preventDefault();
      const v=e.dataTransfer.getData('text/plain');
      const from=state.menu.findIndex(x=>x.view===v);
      const to=state.menu.findIndex(x=>x.view===m.view);
      const [moved]=state.menu.splice(from,1);
      state.menu.splice(to,0,moved);
      persistAll(); buildMenu();
    });
    mo.appendChild(li);
  });
}

/* ====== Servicios / T√©cnicas ====== */
function refreshTechs(){
  const selAp=document.getElementById('apTech'), selInv=document.getElementById('invTech');
  selAp.innerHTML= state.techs.map(t=>`<option>${t}</option>`).join('');
  selInv.innerHTML= selAp.innerHTML;
  const ul=document.getElementById('techList'); if(ul){ ul.innerHTML='';
    state.techs.forEach((t,i)=>{
      const li=document.createElement('li'); li.textContent=t+' ';
      const b=document.createElement('button'); b.className='btn small danger'; b.textContent='Eliminar';
      b.onclick=()=>{ state.techs.splice(i,1); persistAll(); refreshTechs(); };
      li.appendChild(b); ul.appendChild(li);
    });
  }
}
function refreshServices(){
  const dl=document.getElementById('servicesList'); dl.innerHTML='';
  state.services.forEach(s=>{ const o=document.createElement('option'); o.value=s.name; dl.appendChild(o); });
  const tbl=document.getElementById('tblSrv'); if(tbl){
    tbl.innerHTML='<tr><th>Servicio</th><th>Precio</th><th></th></tr>'+
      state.services.map((s,i)=>`<tr><td>${s.name}</td><td>$${(+s.price).toFixed(2)}</td><td><button class="btn small" onclick="delSrv(${i})">Eliminar</button></td></tr>`).join('');
  }
}
function delSrv(i){ state.services.splice(i,1); persistAll(); refreshServices(); }

/* ====== Agenda ====== */
function renderAgenda(){
  document.getElementById('apDate').value = S.today();
  document.getElementById('apTime').value = '10:00';
  document.getElementById('filterDate').value = S.today();
  renderCalendar(); renderApTable(); renderSlots();
}
function renderCalendar(){
  const cal=document.getElementById('calendar'); cal.innerHTML='';
  const m=document.getElementById('calMonth').value || new Date().toISOString().slice(0,7);
  const [y,mm]=m.split('-').map(n=>+n);
  const first=new Date(y,mm-1,1);
  const days=new Date(y,mm,0).getDate();
  for(let d=1; d<=days; d++){
    const date=new Date(y,mm-1,d);
    const el=document.createElement('div'); el.className='day';
    if(S.isSameDay(date,new Date())) el.classList.add('today');
    const has=state.appointments.some(a=>a.date===date.toISOString().slice(0,10));
    el.innerHTML=`<div style="font-weight:700">${d}</div><div>${has?'<span class="badge">citas</span>':''}</div>`;
    el.onclick=()=>{ document.getElementById('filterDate').value=date.toISOString().slice(0,10); renderApTable(); renderSlots(); };
    cal.appendChild(el);
  }
}
function isDuplicateAp({date,time,client,tech}){
  return state.appointments.some(a=>a.date===date && a.time===time && a.client.trim().toLowerCase()===client.trim().toLowerCase() && a.tech===tech);
}
function saveAppointment(editId=null){
  const date=apDate.value, time=apTime.value, client=apClient.value, phone=apPhone.value, service=apService.value, tech=apTech.value;
  if(!date||!time||!client) return S.notify('Fecha, hora y cliente son obligatorios.');
  if(!editId && isDuplicateAp({date,time,client,tech})) return S.notify('‚ö†Ô∏è Cita duplicada: misma persona, hora, d√≠a y t√©cnica.');
  if(editId){
    const ap=state.appointments.find(a=>a.id===editId); if(!ap) return;
    ap._history=ap._history||[]; ap._history.push({date:ap.date,time:ap.time,ts:Date.now()});
    ap.date=date; ap.time=time; ap.client=client; ap.phone=phone; ap.service=service; ap.tech=tech;
    log('reagendar',`${client} ${ap._history.at(-1).date}‚Üí${date}`);
  }else{
    const id=S.uid();
    state.appointments.push({id,date,time,client,phone,service,tech, created:Date.now(), status:'ok'});
    scheduleReminder({id,date,time,client,phone});
    log('cita',`${client} ${date} ${time}`);
  }
  persistAll(); renderApTable(); renderSlots(); renderCalendar();
}
let currentEdit=null;
document.getElementById('btnSaveAp').onclick=()=>saveAppointment(currentEdit);
document.getElementById('btnResched').onclick=()=>{
  const sel=document.querySelector('#tblAp input[type=radio]:checked'); if(!sel) return S.notify('Seleccione una cita');
  currentEdit=sel.value; saveAppointment(currentEdit); currentEdit=null;
};
document.getElementById('btnNoShow').onclick=()=>{
  const sel=document.querySelector('#tblAp input[type=radio]:checked'); if(!sel) return S.notify('Seleccione una cita');
  const ap=state.appointments.find(a=>a.id===sel.value); ap.status='no-show';
  state.noshows.push({...ap, nsTs:Date.now()});
  log('no-show',`${ap.client} ${ap.date} ${ap.time}`);
  persistAll(); renderApTable();
};
function renderSlots(){
  const date = document.getElementById('filterDate').value || S.today();
  const booked = state.appointments.filter(a=>a.date===date).map(a=>a.time);
  const slotsEl = document.getElementById('slots'); slotsEl.innerHTML='';
  const open=[];
  for(let h=9; h<=18; h++){
    for(let m of [0,30]){
      const t=`${S.pad(h)}:${S.pad(m)}`;
      if(!booked.includes(t)) open.push(t);
    }
  }
  slotsEl.innerHTML = open.map(t=>`<button class="btn small" onclick="apTime.value='${t}';apDate.value='${date}'">${t}</button>`).join(' ');
}
function renderApTable(){
  const d=document.getElementById('filterDate').value;
  const c=document.getElementById('filterClient').value?.toLowerCase();
  let rows = state.appointments.filter(a=>!d||a.date===d);
  if(c) rows = rows.filter(a=>a.client.toLowerCase().includes(c));
  rows.sort((a,b)=>a.date.localeCompare(b.date)||a.time.localeCompare(b.time));
  const tbl=document.getElementById('tblAp');
  tbl.innerHTML='<tr><th></th><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Tel√©fono</th><th>Servicio</th><th>T√©cnica</th><th>Estatus</th></tr>'+
    rows.map(a=>`<tr>
      <td><input type="radio" name="selAp" value="${a.id}"></td>
      <td>${a.date}</td><td>${a.time}</td><td>${a.client}</td><td>${a.phone||''}</td><td>${a.service||''}</td><td>${a.tech||''}</td>
      <td>${a.status==='no-show'?'<span class="badge">no-show</span>':'‚úÖ'}</td>
    </tr>`).join('');
}
// Calendar & WhatsApp links
document.getElementById('btnGCal').onclick=()=>{
  const date=apDate.value, time=apTime.value, client=apClient.value, service=apService.value;
  if(!date||!time||!client) return S.notify('Completa fecha, hora y cliente.');
  const start=new Date(`${date}T${time}:00`);
  const end=new Date(start.getTime()+60*60*1000);
  const fmt= d => d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
  const loc= state.cfg.salonName;
  const url=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(service||'Cita')+'%20‚Äî%20'+encodeURIComponent(client)}&dates=${fmt(start)}/${fmt(end)}&location=${encodeURIComponent(loc)}&details=${encodeURIComponent('Creado desde Salon Pro')}`;
  window.open(url,'_blank');
};
document.getElementById('btnWhats').onclick=()=>{
  const date=apDate.value, time=apTime.value, client=apClient.value, phone=apPhone.value;
  const loc=state.cfg.salonName;
  const msg=`Hola ${client||''}! Te confirmamos tu cita: ${date} ${time}. Ubicaci√≥n: ${loc}.`;
  const url=`https://wa.me/${(phone||'')?.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`;
  window.open(url,'_blank');
};
// Export/Import citas
document.getElementById('btnExportApJSON').onclick=()=>S.download(`citas-${Date.now()}.json`,JSON.stringify(state.appointments,null,2));
document.getElementById('importApJSON').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  f.text().then(t=>{ state.appointments=JSON.parse(t); persistAll(); renderApTable(); });
};
document.getElementById('btnExportApPDF').onclick=()=>window.print();

/* ====== Recordatorio 24h ====== */
function scheduleReminder({id,date,time,client}){
  const when = new Date(`${date}T${time}:00`).getTime() - 24*60*60*1000;
  const ms = when - Date.now();
  if(ms>0 && ms < 2**31-1) setTimeout(()=> S.notify(`Recordatorio: ${client} ma√±ana ${date} ${time}`), ms);
}

/* ====== Cobros / Facturas ====== */
function renderBilling(){
  invDate.value=S.today(); invTime.value=S.nowTime();
  refreshTechs(); refreshServices();
  // tabla
  const tbl=document.getElementById('tblInv');
  tbl.innerHTML='<tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Servicio</th><th>T√©cnica</th><th>M√©todo</th><th>Monto</th></tr>'+
    state.invoices.map(i=>`<tr><td>${i.date}</td><td>${i.time}</td><td>${i.client}</td><td>${i.service}</td><td>${i.tech}</td><td>${i.pay}</td><td>$${(+i.amount).toFixed(2)}</td></tr>`).join('');
}
document.getElementById('btnSaveInv').onclick=async()=>{
  const inv={id:S.uid(), date:invDate.value,time:invTime.value,client:invClient.value,phone:invPhone.value,service:invService.value,tech:invTech.value,pay:invPay.value,amount:+invAmount.value||0, ts:Date.now()};
  if(!inv.date||!inv.time||!inv.client||!inv.amount) return S.notify('Completa fecha, hora, cliente y monto.');
  state.invoices.push(inv); persistAll(); renderBilling();
  log('cobro', `${inv.client} $${inv.amount.toFixed(2)} (${inv.pay})`);
  // Enviar a Hoja de Cuadre (Apps Script webhook)
  if(state.cfg.webhookUrl){
    try{
      await fetch(state.cfg.webhookUrl,{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({
        type:'invoice', data:{
          fecha:inv.date, hora:inv.time, cliente:inv.client, telefono:inv.phone, servicio:inv.service, tecnica:inv.tech, metodo:inv.pay, monto:inv.amount
        }
      })});
      S.notify('Enviado a Hoja de Cuadre ‚úÖ');
    }catch(e){ console.error(e); S.notify('No se pudo enviar a la Hoja (ver consola).'); }
  }
};
// PDF factura (vista r√°pida con print)
document.getElementById('btnInvoicePDF').onclick=()=>{
  const html = `
    <div style="font-family:${state.cfg.font}">
      <div style="display:flex;gap:10px;align-items:center">
        ${state.cfg.logo?`<img src="${state.cfg.logo}" style="width:48px;height:48px;object-fit:contain">`:''}
        <div>
          <div style="font-weight:800;font-size:20px">${state.cfg.salonName}</div>
          <div style="opacity:.7">Recibo / Factura</div>
        </div>
      </div><hr>
      <div><b>Cliente:</b> ${invClient.value}</div>
      <div><b>Fecha:</b> ${invDate.value} ${invTime.value}</div>
      <div><b>Servicio:</b> ${invService.value} ‚Äî <b>T√©cnica:</b> ${invTech.value}</div>
      <div><b>M√©todo:</b> ${invPay.value} ‚Äî <b>Monto:</b> $${(+invAmount.value||0).toFixed(2)}</div>
      <hr><small>${state.cfg.footer||''}</small>
    </div>`;
  const w=window.open('','print');
  w.document.write(html); w.document.close(); w.focus(); w.print(); w.close();
};
// Exportaciones
document.getElementById('btnExportInvJSON').onclick=()=>S.download(`cobros-${Date.now()}.json`,JSON.stringify(state.invoices,null,2));
document.getElementById('btnExportInvCSV').onclick=()=>{
  const rows=[['Fecha','Hora','Cliente','Tel√©fono','Servicio','T√©cnica','M√©todo','Monto'],
    ...state.invoices.map(i=>[i.date,i.time,i.client,i.phone,i.service,i.tech,i.pay,i.amount])];
  S.download(`cobros-${Date.now()}.csv`, S.csv(rows), 'text/csv');
};
document.getElementById('btnExportInvPDF').onclick=()=>window.print();
document.getElementById('importInvJSON').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  f.text().then(t=>{ state.invoices=JSON.parse(t); persistAll(); renderBilling(); });
};

// Abrir hoja y probar webhook
document.getElementById('btnOpenSheet').onclick=()=>{ if(state.cfg.sheetUrl) window.open(state.cfg.sheetUrl,'_blank'); else S.notify('Configura la URL de la Hoja.'); };
document.getElementById('btnTestWebhook').onclick=()=>{ if(!state.cfg.webhookUrl) return S.notify('Configura webhook en Configuraci√≥n.'); fetch(state.cfg.webhookUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'ping',ts:Date.now()})}).then(()=>S.notify('Webhook OK (ping enviado)')).catch(()=>S.notify('Error de webhook')); };

/* ====== Rendimiento ====== */
function sumBy(arr,fn){return arr.reduce((a,x)=>a+(+fn(x)||0),0)}
function renderAnalytics(){
  // KPIs b√°sicos por rango
  const range=document.getElementById('rangeKPI').value||'month';
  const now=new Date();
  const start = range==='day'?new Date(now.getFullYear(),now.getMonth(),now.getDate()):
                range==='week'?S.addDays(now,-6):
                new Date(now.getFullYear(),now.getMonth(),1);
  const invInRange=state.invoices.filter(i=>new Date(i.date)>=start);
  const total=sumBy(invInRange,i=>i.amount);
  const byTech={}; invInRange.forEach(i=>byTech[i.tech]=(byTech[i.tech]||0)+(+i.amount||0));
  const apInRange=state.appointments.filter(a=>new Date(a.date)>=start);
  const nos=apInRange.filter(a=>a.status==='no-show').length;
  const k=document.getElementById('kpis'); k.innerHTML='';
  const makeK=(title,val)=>{const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div style="color:var(--muted)">${title}</div><div style="font-size:26px;font-weight:800">${val}</div>`; k.appendChild(c);}
  makeK('Ingresos', `$${total.toFixed(2)}`);
  makeK('Citas', apInRange.length);
  makeK('No-shows', nos);

  // Gr√°ficas canvas nativas (sin librer√≠as)
  drawBar('chart1', byTech, 'Ingresos por t√©cnica');
  // top servicios
  const bySrv={}; invInRange.forEach(i=>bySrv[i.service]=(bySrv[i.service]||0)+1);
  drawBar('chart2', bySrv, 'Top servicios (conteo)');
}
document.getElementById('rangeKPI').onchange=renderAnalytics;

function drawBar(canvasId, data, title){
  const c=document.getElementById(canvasId), ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const labels=Object.keys(data); const vals=Object.values(data);
  const W=c.width=c.clientWidth; const H=c.height=c.height;
  const max=Math.max(1,...vals);
  const pad=20, bw=(W-pad*2)/Math.max(1,labels.length);
  ctx.fillStyle='#ffffff'; ctx.font='14px sans-serif'; ctx.fillText(title, pad, 16);
  labels.forEach((lab,i)=>{
    const v=vals[i]; const h=(H-50)*(v/max);
    const x=pad+i*bw+10, y=H-30-h, w=bw-20;
    ctx.fillRect(x,y,w,h);
    ctx.fillText(lab, x, H-10);
    ctx.fillText(v, x, y-4);
  });
}

/* ====== Config ====== */
function renderConfig(){
  cfgSalonName.value=state.cfg.salonName; cfgFont.value=state.cfg.font;
  cfgBg.value=state.cfg.colors.bg; cfgTopbar.value=state.cfg.colors.topbar; cfgBtn.value=state.cfg.colors.btn; cfgAccent.value=state.cfg.colors.accent;
  cfgFooter.value=state.cfg.footer;
  sheetUrlCode.textContent = state.cfg.sheetUrl;
  refreshTechs(); refreshServices(); buildMenu();
  // Usuarios
  renderUsers();
}
btnSaveTheme.onclick=()=>{
  state.cfg.salonName=cfgSalonName.value; state.cfg.font=cfgFont.value;
  state.cfg.colors.bg=cfgBg.value; state.cfg.colors.topbar=cfgTopbar.value; state.cfg.colors.btn=cfgBtn.value; state.cfg.colors.accent=cfgAccent.value;
  state.cfg.footer=cfgFooter.value;
  persistAll(); applyTheme();
};
cfgLogo.onchange=e=>fileToDataUrl(e.target.files[0]).then(url=>{ state.cfg.logo=url; persistAll(); applyTheme(); });
cfgBgImg.onchange=e=>fileToDataUrl(e.target.files[0]).then(url=>{ state.cfg.bgImage=url; persistAll(); applyTheme(); });

btnAddTech.onclick=()=>{ const t=techNew.value?.trim(); if(!t) return; state.techs.push(t); techNew.value=''; persistAll(); refreshTechs(); };
btnAddSrv.onclick=()=>{ const name=srvName.value?.trim(); const price=+srvPrice.value||0; if(!name) return; state.services.push({name,price}); srvName.value=''; srvPrice.value=''; persistAll(); refreshServices(); };

btnExportCfg.onclick=()=>S.download('config.json', JSON.stringify(state.cfg,null,2));
importCfg.onchange=e=>{ const f=e.target.files[0]; if(!f) return; f.text().then(t=>{ state.cfg=JSON.parse(t); persistAll(); applyTheme(); renderConfig(); }) };

// Usuarios
function renderUsers(){
  tblUsers.innerHTML='<tr><th>Usuario</th><th>Rol</th><th></th></tr>'+
   state.users.map((u,i)=>`<tr><td>${u.user}</td><td>${u.role}</td><td><button class="btn small danger" onclick="delUser(${i})">Eliminar</button></td></tr>`).join('');
}
function delUser(i){ state.users.splice(i,1); persistAll(); renderUsers(); }
btnAddUser.onclick=()=>{
  const u=uUser.value?.trim(), p=uPass.value, r=uRole.value;
  if(!u||!p) return S.notify('Usuario y contrase√±a requeridos.');
  if(state.users.some(x=>x.user===u)) return S.notify('Usuario ya existe.');
  state.users.push({user:u,pass:p,role:r}); persistAll(); renderUsers();
}

/* ====== Backups ====== */
function renderBackups(){}
document.getElementById('btnSchedBackups').onclick=()=>{
  S.notify('Backups programados (simulado con timers locales). Se generar√°n archivos descargables.');
};
document.querySelectorAll('[data-backup]').forEach(b=>{
  b.onclick=()=>{
    const [what,freq]=b.dataset.backup.split(':');
    const data = what==='appointments'?state.appointments:what==='billing'?{invoices:state.invoices, noshows:state.noshows}:{};
    S.download(`${what}-${freq}-${Date.now()}.json`, JSON.stringify(data,null,2));
  }
});
document.getElementById('btnExportAll').onclick=()=>{
  const dump = {cfg:state.cfg, users:state.users, menu:state.menu, techs:state.techs, services:state.services, appointments:state.appointments, invoices:state.invoices, noshows:state.noshows, logs:state.logs};
  S.download(`backup-total-${Date.now()}.json`, JSON.stringify(dump,null,2));
};
document.getElementById('importAll').onchange=e=>{
  const f=e.target.files[0]; if(!f) return; f.text().then(t=>{ const dump=JSON.parse(t); Object.assign(state,dump); persistAll(); applyTheme(); buildMenu(); S.notify('Restaurado.'); });
};

/* ====== Logs ====== */
function log(type,msg){
  state.logs.push({id:S.uid(), type, msg, ts:Date.now(), user:state.session?.user||'anon'});
  S.save('logs', state.logs);
}
function renderLogsTable(){
  tblLogs.innerHTML='<tr><th>Fecha</th><th>Usuario</th><th>Tipo</th><th>Mensaje</th></tr>' +
    state.logs.slice(-200).reverse().map(l=>`<tr><td>${S.toLocalDateTimeStr(new Date(l.ts))}</td><td>${l.user}</td><td>${l.type}</td><td>${l.msg}</td></tr>`).join('');
}

/* ====== Helpers ====== */
function fileToDataUrl(file){return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });}

/* ====== Eventos de UI ====== */
document.querySelectorAll('[data-back]').forEach(b=>b.onclick=toMenu);
btnDashboard.onclick=toMenu;
btnLogout.onclick=logout;
btnDoLogin.onclick=()=>login(loginUser.value, loginPass.value);

filterDate.onchange=()=>{ renderApTable(); renderSlots(); };
filterClient.oninput=()=>renderApTable();
calMonth.oninput=()=>renderCalendar();

/* ====== Cargar ====== */
(function init(){
  applyTheme();
  if(state.session) toMenu(); else show('viewLogin');
  refreshTechs(); refreshServices();
  renderLogsTable();
  // PWA
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
})();
</script>
</body>
</html>
